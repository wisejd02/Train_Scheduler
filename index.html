<!doctype html>
<html lang="en">
<head>
	<title>Train Scheduler</title>
	<!-- Required meta tags -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<!-- Bootstrap CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
	<script src="https://www.gstatic.com/firebasejs/4.8.0/firebase.js"></script>
	<link rel="stylesheet" type="text/css" href="assets/style.css">
	<link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet">
</head>
<body>
	<div class="container">
		<div class="jumbotron jumbotron-fluid">
			<div class="container">
				<h1 class="display-3" style="text-align:center">Train Schedule Management System</h1>
				<p class="lead" style="text-align:center">We choo choo choose you!</p>
			</div>

		</div>
		<div class="panel panel-primary">
			<div class="panel-heading">Current Train Schedule</div>
			<div class="panel-body">
				<table class="table table-striped table-bordered">
					<thead>
						<tr>
							<th scope="col"></th>
							<th scope="col">Train Name</th>
							<th scope="col">Destination</th>
							<th scope="col">First Train Time</th>
							<th scope="col">Frequency (mins)</th>
							<th scope="col">Next Arrival</th>
							<th scope="col">Minutes Away</th>
						</tr>
					</thead>
					<tbody>
					</tbody>
				</table>
			</div>
		</div>
		<div class="panel panel-primary">
				<div class="panel-heading">Add Train</div>
				<div class="panel-body">
					<form>
						<div class="form-group">
							<label for="trainName">Train Name</label>
							<input type="text" class="form-control" id="trainName" placeholder="Enter Train Name Here">
						</div>
						<div class="form-group">
							<label for="trainDest">Destination</label>
							<input type="text" class="form-control" id="trainDest" placeholder="Enter Destination Here">
						</div>
						<div class="form-group">
							<label for="firstTrain">First Train</label>
							<input type="text" class="form-control" id="firstTrain" placeholder="Enter First Train Time Here (HrMin)">
						</div>
						<div class="form-group">
							<label for="trainFreq">Frequency</label>
							<input type="text" class="form-control" id="trainFreq" placeholder="Enter Freq In Mins Here">
						</div>
						<button id="btnFrmSubmit" class="btn btn-primary">Submit</button>
					</form>
				</div>
		</div>

	</div>
	<!-- Optional JavaScript -->
	<!-- jQuery first, then Popper.js, then Bootstrap JS -->
	<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
	<!-- Link to Moment.js should go here -->
	<script src="https://cdn.jsdelivr.net/momentjs/2.12.0/moment.min.js"></script>

	<script type="text/javascript">
		 // Initialize Firebase
		 var config = {
			apiKey: "AIzaSyBk2pHNz0EinDznYAMc6g_quxiE5uByHzQ",
			authDomain: "fir-proj-fc54a.firebaseapp.com",
			databaseURL: "https://fir-proj-fc54a.firebaseio.com",
			projectId: "fir-proj-fc54a",
			storageBucket: "fir-proj-fc54a.appspot.com",
			messagingSenderId: "936997790614"
		 };
		 firebase.initializeApp(config);
		 var database = firebase.database();
		 var trainName = "";
		 var trainDest = "";
		 var trainFreq = "";
		 var trainFreq = "";

		 database.ref("train_schedule").orderByChild("dateAdded").on("child_added", function(response) {
			 var dbUID;
			 var tFrequency = response.val().trainFreq;
			 var firstTimeConverted = moment(response.val().firstTrain, "hh:mm").subtract(1, "years");
			 // Current Time
			 var currentTime = moment();
			 // Difference between the times
			 var diffTime = moment().diff(moment(firstTimeConverted), "minutes");
			 // Time apart (remainder)
			 var tRemainder = diffTime % tFrequency;
			 // Minute Until Train
			 var tMinutesTillTrain = tFrequency - tRemainder;
			 // Next Train
			 var nextTrain = moment().add(tMinutesTillTrain, "minutes").format("HH:mm");

		 	$("tbody").append(`
		 		<tr id="${response.key}">
					<td><button class="btn btn-edit btn-upd">Edit</button>
					<button class="btn btn-edit btn-del onclick="onClickDelete('')">Delete</button></td>
					<td>${response.val().trainName}</td>
					<td>${response.val().trainDest}</td>
					<td>${response.val().firstTrain}</td>
					<td>${response.val().trainFreq}</td>
					<td>${nextTrain}</td>
					<td>${tMinutesTillTrain}</td>
		 		</tr>`)
			$("button.btn-upd").click( function(){
				console.log("Edit");
				//console.log($(this).parents('tr')[0]);
				var currentTD = $(this).parents('tr').find('td');
              if ($(this).html() == 'Edit') {
                  currentTD = $(this).parents('tr').find('td');
				  console.log(currentTD);
				  
                  $.each(currentTD, function (index, val) {
					  console.log(this);
					  console.log(index);
					  if(index != 0 && index < 5){
						$(this).prop('contenteditable', true)
					  }
                      
                  });
              } else {
                 $.each(currentTD, function () {
					 console.log("save should be")
                      $(this).prop('contenteditable', false)
                  });
				  dbUID = $(this).parents('tr')[0].id;
				  var updateTrainData = {
					trainName: $(this).parents('tr')[0].cells[1].innerHTML.trim(),
		 			trainDest: $(this).parents('tr')[0].cells[2].innerHTML.trim(),
					firstTrain: moment($(this).parents('tr')[0].cells[3].innerHTML.trim(), "HHmm").format("HH:mm"),
		 			trainFreq: $(this).parents('tr')[0].cells[4].innerHTML.trim(),
		 			dateAdded: firebase.database.ServerValue.TIMESTAMP
				  }
				  database.ref("train_schedule/"+dbUID).set(updateTrainData);
              }
    
              $(this).html($(this).html() == 'Edit' ? 'Save' : 'Edit')
			});
			$(".btn-del").click( function(){
				dbUID = $(this).parents('tr')[0].id;
				console.log("delete");
				console.log($(this).parents('tr'));
				$(this).parents('tr')[0].remove()
				database.ref("train_schedule/"+dbUID).remove()
			});
		 });


		 $("#btnFrmSubmit").click( function(e){
		 	e.preventDefault();
		 	var formData = {
		 		trainName: $("#trainName").val().trim(),
		 		trainDest: $("#trainDest").val().trim(),
				firstTrain: moment($("#firstTrain").val().trim(), "HHmm").format("HH:mm"),
		 		trainFreq: $("#trainFreq").val().trim(),
		 		dateAdded: firebase.database.ServerValue.TIMESTAMP
		 	};
		 	updateTrain(formData);
			 var formEntry = $(".form-control");
			 $.each(formEntry, function( index, value ) {
				$("#"+formEntry[index].id).val("");
			 });
		 	// database.ref().orderByChild("dateAdded").limitToLast(1).on("child_added", function(snapshot) {
		 	// 	var sv = snapshot.val();
		 	// 	console.log(sv);


		 	// });
		 });
		 

		 $("tr").click( function(){
			 console.log("tr");
			 console.log(this);
		 });
		 function updateTrain(obj){
			database.ref("train_schedule").push(obj);

		 };


		</script>
	</body>
	</html>












